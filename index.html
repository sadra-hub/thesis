<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thesis Project — Data-Driven Decision Support</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/computer-modern-web-font@1.0.0/css/cmun-roman.min.css">
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root{
      --bg:#fff; --fg:#000; --overlay:rgba(0,0,0,.96); --line:#000; --lightgray:#f2f2f2;
      --font-serif:'CMU Serif','Computer Modern Roman','Times New Roman',serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--font-serif);}
    body.no-scroll{overflow:hidden}
    a{color:var(--fg);text-decoration:none;border-bottom:1px solid var(--line)}
    a:hover{opacity:.7}
    .header{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:flex-end;padding:0 16px;z-index:5}
    .menu-btn{cursor:pointer;width:40px;height:40px;border:1px solid var(--line);border-radius:999px;display:flex;align-items:center;justify-content:center;background:#fff}
    .menu-icon,.menu-icon::before,.menu-icon::after{content:"";display:block;width:18px;height:2px;background:#000;position:relative;transition:transform .3s ease,opacity .3s ease}
    .menu-icon::before{position:absolute;top:-6px}
    .menu-icon::after{position:absolute;top:6px}
    .overlay{position:fixed;inset:0;background:var(--overlay);color:#fff;display:none;align-items:center;justify-content:center;z-index:10}
    .overlay.open{display:flex;animation:fadeIn .25s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .overlay-nav{text-align:center}
    .overlay-nav a{display:block;font-size:clamp(40px,8vw,86px);color:#fff;margin:18px 0;border:none;letter-spacing:.04em}
    .landing{height:100vh;width:100vw;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:0 24px;overflow:hidden}
    .title{font-size:clamp(28px,5vw,54px);max-width:960px;line-height:1.15;margin:0 0 16px}
    .subtitle{font-size:clamp(16px,2.2vw,22px);opacity:.9;margin:0 0 28px}
    .cta{display:flex;gap:16px;flex-wrap:wrap;justify-content:center}
    .btn{border:1px solid var(--line);padding:12px 18px;text-transform:uppercase;letter-spacing:.06em;font-size:13px;background:#fff;cursor:pointer}
    .btn:hover{background:#000;color:#fff}
    .logos{position:fixed;bottom:18px;left:0;right:0;display:flex;justify-content:center;align-items:center;gap:28px;filter:grayscale(1) contrast(1.2);opacity:.9}
    .logos img{height:26px;opacity:.85}
    main{min-height:100vh;width:100%}
    .page{display:none;padding:96px 24px 48px;max-width:1100px;margin:0 auto}
    .page.active{display:block}
    h1{font-weight:400;font-size:32px;margin:0 0 16px}
    h2{font-weight:400;font-size:22px;margin:24px 0 8px}
    .muted{color:#333}
    hr{border:none;border-top:1px solid #000;margin:24px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{border:1px solid #000;padding:14px;background:#fff;display:flex;flex-direction:column;gap:8px}
    .card .name{font-size:16px}
    .viewer{border:1px solid #000;height:70vh;background:#fff;overflow:auto}
    .viewer iframe,.viewer embed{width:100%;height:100%;display:block;border:none}
    .pdf-toolbar{display:flex;gap:8px;align-items:center;border-bottom:1px solid #000;padding:6px;background:#fff;position:sticky;top:0;z-index:1}
    .pdf-pages{padding:8px 0}
    canvas.pdf-page{display:block;margin:12px auto;max-width:100%;height:auto}
    pre{background:#fff;border:1px solid #000;padding:12px;overflow:auto;font-family:var(--font-mono);font-size:13px;line-height:1.5}
    .chat-wrap{max-width:760px;margin:0 auto}
    .chat-box{border:1px solid #000;height:60vh;overflow:auto;padding:16px;background:#fff}
    .msg{margin:10px 0}
    .msg.me{text-align:right}
    .msg .bubble{display:inline-block;border:1px solid #000;padding:8px 12px;background:#fff}
    .msg.me .bubble{background:#000;color:#fff}
    .chat-input{display:flex;gap:8px;margin-top:12px}
    .chat-input input{flex:1;border:1px solid #000;padding:10px 12px;font-family:var(--font-serif)}
    .chat-input button{border:1px solid #000;background:#fff;padding:10px 14px;text-transform:uppercase;letter-spacing:.06em}
    .chat-input button:hover{background:#000;color:#fff}
    .license-overlay{position:absolute;inset:0;background:var(--lightgray);border:1px dashed #000;display:flex;align-items:center;justify-content:center;text-align:center;padding:24px;font-size:16px;line-height:1.5}
    .license-overlay img{height:28px;display:block;margin:8px auto 0;filter:grayscale(1)}
    .hidden{display:none !important}
    .relative{position:relative}
    .right-actions{float:right}
  </style>
</head>
<body>
  <header class="header">
    <button class="menu-btn" id="openMenu" aria-label="Open Menu"><span class="menu-icon"></span></button>
  </header>

  <div class="overlay" id="overlay">
    <nav class="overlay-nav">
      <a href="#/home" data-route>Home</a>
      <a href="#/documents" data-route>Documents</a>
      <a href="#/models" data-route>Models</a>
      <a href="#/demo" data-route>Demo</a>
    </nav>
  </div>

  <section class="landing" id="landing">
    <h1 class="title">Data-Driven Decision Support in Systems Engineering</h1>
    <p class="subtitle">Through Linked Descriptive and Analytical Models</p>
    <div class="cta">
      <a class="btn" href="#/documents">Open Documents</a>
      <a class="btn" href="#/models">Open Models</a>
      <a class="btn" href="#/demo">Open Demo</a>
    </div>
  </section>

  <div class="logos" id="logos">
    <img src="assets/logos/tue-black.png" alt="TU/e Logo (BW)">
    <img src="assets/logos/tno-esi-black.svg" alt="TNO-ESI Logo (BW)">
    <img src="assets/logos/incose-black.png" alt="INCOSE Logo (BW)">
    <img src="assets/logos/tom-sawyer-black.png" alt="Tom Sawyer Logo (BW)">
    <img src="assets/logos/syside-black.png" alt="SysIDE Logo (BW)">
  </div>

  <main>
    <section class="page" id="page-docs" aria-labelledby="docsTitle">
      <h1 id="docsTitle">Documents</h1>
      <p class="muted">All files listed from the <code>/docs</code> folder of this repository. Click to preview PDFs inline or open text files.</p>
      <hr>
      <div id="docsList" aria-live="polite"></div>
      <h2>Preview</h2>
      <div id="docViewer" class="viewer"></div>
    </section>

    <section class="page" id="page-models" aria-labelledby="modelsTitle">
      <h1 id="modelsTitle">Models</h1>
      <p class="muted">SysML models and related assets from the <code>/models</code> folder.</p>
      <hr>
      <div id="modelsList" class="grid" aria-live="polite"></div>
      <h2>Preview</h2>
      <div id="modelViewer" class="viewer relative"></div>
    </section>

    <section class="page" id="page-demo" aria-labelledby="demoTitle">
      <h1 id="demoTitle">Demo — LLM Chat <span class="right-actions"><button id="reportBtn" class="btn" style="margin-left:12px;">Generate latest report</button></span></h1>
      <p class="muted">Use this chat to ask questions about the project. Messages are routed to the backend and responses include updates so you can track progress and understand system decisions over time.</p>
      <div class="chat-wrap">
        <div id="chatBox" class="chat-box" aria-live="polite"></div>
        <div class="chat-input">
          <input id="chatInput" type="text" placeholder="Type a message…" />
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== CONFIG =====
    const GITHUB_USER = 'sadra-hub';
    const GITHUB_REPO = 'thesis';
    const BRANCH      = 'master';

    const WEBHOOK_CHAT   = 'https://backend.systein.nl/webhook/thesis-chat';
    const WEBHOOK_REPORT = 'https://backend.systein.nl/webhook/thesis-report';

    // PDF.js worker
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // ===== MENU/ROUTER =====
    const overlay = document.getElementById('overlay');
    const openMenuBtn = document.getElementById('openMenu');
    const logos = document.getElementById('logos');
    openMenuBtn.addEventListener('click', () => overlay.classList.add('open'));
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay || e.target.matches('[data-route]')) {
        overlay.classList.remove('open');
      }
    });

    const landing = document.getElementById('landing');
    const pages = {
      documents: document.getElementById('page-docs'),
      models: document.getElementById('page-models'),
      demo: document.getElementById('page-demo')
    };

    function setRoute() {
      const raw = location.hash.replace('#/','');
      const hash = raw || 'home';
      Object.values(pages).forEach(p => p.classList.remove('active'));
      if (hash === 'home'){
        landing.classList.remove('hidden');
        logos.classList.remove('hidden');
        document.body.classList.add('no-scroll');
        return;
      }
      landing.classList.add('hidden');
      logos.classList.add('hidden');
      document.body.classList.remove('no-scroll');
      if (pages[hash]){
        pages[hash].classList.add('active');
        if (hash === 'documents') loadDocs();
        if (hash === 'models') loadModels();
      }
    }
    window.addEventListener('hashchange', setRoute);
    window.addEventListener('load', setRoute);

    // ===== GITHUB HELPERS =====
    function ghContentsPath(path){
      return `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;
    }
    function rawGitURL(path){
      return `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${path}`;
    }

    function createCard(name, path, isBinary){
      const card = document.createElement('div');
      card.className = 'card';
      const title = document.createElement('div');
      title.className = 'name';
      title.textContent = name;
      const viewBtn = document.createElement('button');
      viewBtn.textContent = 'Preview';
      viewBtn.className = 'btn';
      viewBtn.style.width = '100%';
      viewBtn.addEventListener('click', () => previewFile(path, isBinary, path.startsWith('docs/') ? 'docViewer' : 'modelViewer'));
      card.appendChild(title);
      card.appendChild(viewBtn);
      return card;
    }

    async function listFolder(path){
      const res = await fetch(ghContentsPath(path));
      if (!res.ok) throw new Error('GitHub API error: ' + res.status);
      return res.json();
    }

    async function loadDocs(){
      const mount = document.getElementById('docsList');
      mount.innerHTML = '';
      try{
        const items = await listFolder('docs');
        const dirs = items.filter(it => it.type === 'dir');
        const rootFiles = items.filter(it => it.type === 'file');

        const renderSection = (titleText, files, basePath='docs') => {
          const section = document.createElement('section');
          const h2 = document.createElement('h2');
          h2.textContent = titleText;
          const grid = document.createElement('div');
          grid.className = 'grid';
          files.filter(it => it.type === 'file').forEach(it => {
            const name = it.name;
            const path = `${basePath}/${name}`;
            const isBinary = /(pdf|png|jpg|jpeg|svg)$/i.test(name);
            grid.appendChild(createCard(name, path, isBinary));
          });
          section.appendChild(h2);
          section.appendChild(grid);
          mount.appendChild(section);
        };

        if (rootFiles.length){ renderSection('General', rootFiles, 'docs'); }
        for (const dir of dirs){
          try{
            const files = await listFolder(`docs/${dir.name}`);
            renderSection(dir.name, files, `docs/${dir.name}`);
          }catch(e){
            const errCard = document.createElement('div');
            errCard.className = 'card';
            errCard.innerHTML = `<strong>${dir.name}</strong><br/>Unable to list directory.<br><code>${e.message}</code>`;
            mount.appendChild(errCard);
          }
        }
      }catch(err){
        mount.innerHTML = `<div class=\"card\">Unable to list /docs. Configure GITHUB_USER/REPO or ensure the folder exists.<br><code>${err.message}</code></div>`;
      }
    }

    async function loadModels(){
      const mount = document.getElementById('modelsList');
      mount.innerHTML = '';
      try{
        const items = await listFolder('models');
        items.filter(it => it.type === 'file').forEach(it => {
          const name = it.name;
          const path = `models/${name}`;
          const isBinary = /(png|jpg|jpeg|svg|pdf)$/i.test(name);
          mount.appendChild(createCard(name, path, isBinary));
        });
      }catch(err){
        mount.innerHTML = `<div class=\"card\">Unable to list /models. Configure GITHUB_USER/REPO or ensure the folder exists.<br><code>${err.message}</code></div>`;
      }
      const modelViewer = document.getElementById('modelViewer');
      modelViewer.innerHTML = '';
      const overlay = document.createElement('div');
      overlay.className = 'license-overlay';
      overlay.innerHTML = `Academic Licence pending from Tom Sawyer<br/><img src=\"assets/logos/tom-sawyer-black.png\" alt=\"Tom Sawyer\">`;
      modelViewer.appendChild(overlay);
    }

    // ===== Robust inline preview using PDF.js =====
    async function previewFile(path, isBinary, viewerId){
      const viewer = document.getElementById(viewerId);
      viewer.innerHTML = '';
      const url = rawGitURL(path);
      try{
        if (isBinary && /pdf$/i.test(path)){
          const res = await fetch(url, { cache:'no-store' });
          if(!res.ok) throw new Error('Failed to fetch PDF: ' + res.status);
          const buffer = await res.arrayBuffer();
          renderPdfWithPdfJs(buffer, viewer);
        } else if (isBinary){
          const res = await fetch(url, { cache:'no-store' });
          if(!res.ok) throw new Error('Failed to fetch image: ' + res.status);
          const blob = await res.blob();
          const blobUrl = URL.createObjectURL(blob);
          const img = document.createElement('img');
          img.src = blobUrl; img.alt = path; img.style.maxWidth='100%'; img.style.maxHeight='100%';
          viewer.appendChild(img);
        } else {
          const res = await fetch(url, { cache:'no-store' });
          if(!res.ok) throw new Error('Failed to fetch text: ' + res.status);
          const text = await res.text();
          const pre = document.createElement('pre');
          pre.textContent = text;
          viewer.appendChild(pre);
        }
      }catch(err){
        viewer.innerHTML = `<div class='card'>Preview unavailable. <a href='${url}' target='_blank'>Open in new tab</a><br><code>${err.message}</code></div>`;
      }
    }

    function renderPdfWithPdfJs(arrayBuffer, mount){
      if (!window['pdfjsLib']){
        mount.innerHTML = `<div class='card'>PDF.js not available.</div>`; return;
      }
      mount.innerHTML = '';
      const toolbar = document.createElement('div');
      toolbar.className = 'pdf-toolbar';
      const zoomOut = document.createElement('button'); zoomOut.className='btn'; zoomOut.textContent='−';
      const zoomIn  = document.createElement('button'); zoomIn.className='btn';  zoomIn.textContent='+';
      const status  = document.createElement('span'); status.style.marginLeft='8px'; status.textContent='Loading…';
      toolbar.appendChild(zoomOut); toolbar.appendChild(zoomIn); toolbar.appendChild(status);
      const pagesWrap = document.createElement('div'); pagesWrap.className = 'pdf-pages';
      mount.appendChild(toolbar); mount.appendChild(pagesWrap);

      let pdfDoc = null; let scale = 1.15; let currentTask = null;

      const renderAll = async () => {
        pagesWrap.innerHTML = '';
        status.textContent = `Pages: ${pdfDoc.numPages} — Zoom: ${(scale*100).toFixed(0)}%`;
        for (let p=1; p<=pdfDoc.numPages; p++){
          const page = await pdfDoc.getPage(p);
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement('canvas'); canvas.className='pdf-page';
          const ctx = canvas.getContext('2d');
          canvas.width = Math.floor(viewport.width);
          canvas.height = Math.floor(viewport.height);
          pagesWrap.appendChild(canvas);
          await page.render({ canvasContext: ctx, viewport }).promise;
        }
      };

      pdfjsLib.getDocument({ data: arrayBuffer }).promise
        .then(doc => { pdfDoc = doc; return renderAll(); })
        .catch(err => { pagesWrap.innerHTML = `<div class='card'>Failed to render PDF.<br><code>${err.message}</code></div>`; });

      zoomIn.onclick = () => { scale = Math.min(scale + 0.15, 3.0); renderAll(); };
      zoomOut.onclick = () => { scale = Math.max(scale - 0.15, 0.5); renderAll(); };
    }

    // ===== CHAT =====
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    function addMsg(text, me=false){
      const wrap = document.createElement('div');
      wrap.className = 'msg' + (me ? ' me' : '');
      const b = document.createElement('div');
      b.className = 'bubble'; b.textContent = text;
      wrap.appendChild(b); chatBox.appendChild(wrap); chatBox.scrollTop = chatBox.scrollHeight;
    }
    async function sendMessage(){
      const msg = chatInput.value.trim();
      if(!msg) return; addMsg(msg, true); chatInput.value='';
      try{
        const url = new URL(WEBHOOK_CHAT); url.searchParams.set('message', msg);
        const res = await fetch(url.toString(), { method:'GET' });
        let reply = ''; const ct = res.headers.get('content-type') || '';
        if(ct.includes('application/json')){ const data = await res.json(); reply = data.response || data.result || JSON.stringify(data); }
        else { reply = await res.text(); }
        addMsg(reply || '[No response]');
      }catch(err){ addMsg('[Error] ' + err.message); }
    }
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });

    // ===== REPORT BUTTON =====
    const reportBtn = document.getElementById('reportBtn');
    if (reportBtn){
      reportBtn.addEventListener('click', async ()=>{
        const original = reportBtn.textContent; reportBtn.textContent = 'Generating…'; reportBtn.disabled = true;
        try{
          const res = await fetch(WEBHOOK_REPORT, { method:'GET' });
          if(!res.ok) throw new Error('Report request failed: ' + res.status);
          const blob = await res.blob();
          const ct = res.headers.get('content-type') || 'application/octet-stream';
          const ext = ct.includes('pdf') ? 'pdf' : (ct.includes('zip') ? 'zip' : 'bin');
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `thesis-report.${ext}`; document.body.appendChild(a); a.click(); a.remove();
        }catch(err){ alert('Could not generate report: ' + err.message); }
        finally { reportBtn.textContent = original; reportBtn.disabled = false; }
      });
    }
  </script>
</body>
</html>